# 嘉兴农药喷洒车调试文档

## 3月28日调试日志

### 完成内容

抵达嘉兴，遥控启动农药喷洒小车

### 待解决的问题

1. 小车的整体系统运行问题（车上现有系统比较老，需要更新并重试）
2. 小车定位问题
   1. 启动时GPS初始化慢
   2. 室内GPS定位精度有待验证，角度可能存在错误（角度需要更长时间初始化）
   3. 小车定位算法逻辑问题（目前小车需要实现一个稳定精确的室内定位系统，能使小车在室内自由定位导航）
3. 小车工作逻辑问题（垄间作业模式实现）——具体策略有待验证
   1. 主路上定位导航功能
   2. 垄间作业模式的编写（实质上是一个循迹问题，判断可通行区域，进行控制操作；垄间作业不一定需要GPS，垄的环境相对复杂，建图不现实）
   3. 两者之间的切换



## 3月29日调试日志

### 完成内容

1. 完成遥控建图任务，录制了四个数据包，分别是棚内主干道直行再倒退回原位、主干道直行再掉头回到原位、入垄行进再掉头、入垄行进再倒车

### 遇到的问题

1. 激光雷达安装位置预留空间不足  在用笔记本的nomachine远程连接NX系统时，误触关闭了网络连接，导致无法用笔记本再次开启NX的网络，无法再进行远程连接
3. nomachine无法连接，NX上的nomachine版本低

### 解决方法（分别对应遇到的问题）

1. 将上装农药喷洒装置向滑轨后端移动一小段距离，完成安装激光雷达
2. 拆卸上装与NX的前盖找到HDMI接口与USB接口，用显示器连接NX启动了网络，然后就可以继续用笔记本远程调试NX
3. 强制更新了NX上的nomachine

### 待解决的问题

1. 发布导航任务后，可以准确生成控制指令cmd_vel，但是无法将cmd_vel发布给CAN卡，因此CAN无法将控制指令传给底层STM32板完成解析指令的任务，杰哥今天尝试修复了这个漏洞，效果明日验证。
2. 在最后一次建图后重启小车电源，NX无法启动，稳定性不行



## 3月30日调试日志

### 今日任务

1. 测试GNSS漂移，测试方法：由棚外主路进入棚内；棚外原地旋转；棚内原地旋转；评估漂移程度
2. 考虑室内纯激光定位算法或者寻找有效的GNSS与激光融合定位

### 遇到的问题

1. 远程调试给的控制指令有问题，车辆失控进入垄内
2. GPS在棚内无法使用，精确度很低
3. 紧急制动按钮位置不合适，车辆转向比较急的时候很难及时按下
4. 调试中有一次无法通过遥控器给转向命令

### 解决办法

1. CAN已经可以收到cmd_vel的指令了，但是转到CAN的解析有问题
2. 用纯激光建图定位
3. 需要后期调整紧急制动按钮的位置
4. 触发了电流保护，需要降低自动导航时的最大加速度的阈值



## 3月31日调试日志

### 完成内容

1. 解决了偶然间小车重启后无法进入自动导航模式的问题
2. 小车底盘can参数调试，分别测了小车的线速度、角速度与电机转速的对应比例转换关系，即cmd_vel-->rpm
3. dwa局部规划器参数调试，根据小车实际运行结果设置最大线速度、角速度、以及线加速度、角加速度以及规划频率sim_time

### 遇到的问题

1. 小车收到规划目标点后，全局规划没问题，控制参数或规划参数有问题，小车实际运行时前轮左右轻微振荡。
2. 调完底盘参数后，再调节规划参数时，小车前后也出现振荡现象，考虑是最大加速度设置太小，车辆当前不可行时需要规划新的速度指令，反而使得速度出现正负交替振荡。

### 解决办法

1. 先调底盘参数，通过调节小车的线速度、角速度与电机转速的对应比例转换关系，使得底层控制变得精确。小车左右轻微振荡问题得到缓解。
2. 通过调节规划参数可以使得问题得到缓解，但是问题2目前还没有完全解决



## 4月1日调试日志

### 完成内容

1. 配合南京来的测试人员测试棚内GPS信号，GPS信号在棚外露天工况下误差5cm内，棚内定位误差8-10cm
2. 录制棚内GPS定位信息

## 4月2日调试日志

### 完成内容

1. 调试小车循迹，棚内主路误差可接受，垄间精度要求更高反而误差比较大，纯GPS室内定位方案不可行

### 待解决的问题

1. 整体循迹逻辑开发
2. 解决定位问题
3. 跟踪车后目标点时，小车无法自转180°，目前无法倒车且只能向右旋转

### 明日任务

调试规划频率与控制频率，降低控制频率，联调这两个频率，看对小车的控制平顺性有没有帮助

## 4月3日调试日志

### 完成内容

1. 解决了底盘的控制问题：小车无法掉头、前进不平顺。解决办法是调低controller_frequency，设置为2HZ（原来为10HZ），controller_frequency决定了cmd_vel的发布频率，若设置太大，则计算机算力难以满足，更重要的是控制指令频率太高会使得控制不平顺，planner_frequency设置为0，即只有当目标点发生变化时才会重新规划全局路径。        
2. 解决了垄内（非玉米地）的入垄循迹问题
3. 调试从室外到棚内的定点目标跟踪

### 待解决的问题

1. 小车可以入垄，但是退后出垄的时候有问题
2. 采用A、B、C、D这种GPS任务点的目标跟踪问题严重依赖GPS的精度，目前棚内环境较为复杂，垄间道路狭窄，尤其是主路到达入垄点D的时候无法准确对准目标垄。
3. 缺少由move_base运动规划控制到入垄作业的模式切换逻辑



