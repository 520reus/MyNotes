今天学习了自动驾驶的一些基本概念，加深了对运动规划周期与控制周期的理解

# 为什么自动驾驶运动规划的更新周期那么短，却要规划出那么长的一段轨迹？

​		**运动规划**是自动驾驶技术栈中的关键一步，**负责把上游的孤立、异构、模糊的多方面信息整合成自洽的运动轨迹（trajectory）**；好的轨迹需要满足多方面的要求，其中最重要的方面包括**安全性（safety）和舒适性**（comfort）。对于车辆自动驾驶来说，**车辆的控制是限制在地面这个二维世界里**。但轨迹并不在这个空间中，因为**轨迹并不仅是简单的一个瞬时的状态，也需要考虑时间这一维度**。因此，**它是一条在二维空间和一维时间组成的三维空间中的曲线**。**轨迹的时间跨度，称为时域（horizon）**，通常要达到**8-10**秒这个范围（这个时间也跟算法的优化结果相关），才能满足公开道路产品级自动驾驶的需求。

为什么要在比较长的时间跨度上规划完整的运动，而不能只是简单地规划当前瞬间的动作（油门、刹车、转向）呢？

​		目前很多基于端到端学习的规划方法都是这么做的，毕竟人类司机驾驶时，很多时候也只考虑眼前需要的动作而已。进行长时程的完整规划主要是为了保证未来的规划问题仍然可解。车辆从动力学上来说，惯性很大；从运动学上来说，又属于**非完整系统（non-holonomic，即车辆不能瞬间改变朝向）**，所以如果只考虑当前位姿，是不能作出有前瞻性的驾驶动作的。缺乏前瞻性的驾驶动作虽然目前看来不错，但很容易把自己开进死胡同，造成一段时间之后无解。如果观察到路口的红灯，无人车必须根据当前速度提前刹车才能保证不闯红灯；如果只考虑眼前，会发现在到达路口之前都没有刹车的必要（不会立刻违反交通规则），而到了路口，再刹车就来不及了。
**这就是为什么模块的名字叫做运动规划（motion planning）——规划就是计划未来。**端到端学习的方法只输出当前驾驶动作，实际上相当于把控制（control）也囊括在内了，但通常模型内部还是需要通过辅助损失函数（auxiliary  loss）等方式对未来有一个预测和考量的（比如Waymo的ChauffeurNet）。在时空的三维空间中的轨迹，可以完整地描述未来一段时间之内的运动的全貌。**因此，对这个完整运动的最优解算就可以实现有前瞻性的运动规划。这就是为什么我们要在运动规划的时候考虑未来时间这个维度。**

**总结如下：**

- **驾驶感受：**驾驶员的大脑在时刻的运转，我们每看一次道路其实就是重新做了一次规划Replan，我们看的足够远我们的规划才足够稳定。如果我们的视线只盯着车前2m，车开的大概率是左冲右撞的，因为只有到跟前了我们才知道前边有个障碍物，慌忙打方向或紧急刹车。
- **算法优化：**在简单静态环境中，运动规划完全可以使用初始时刻规划好未来的一段路径和对应的速度，直到到达规划的终点再重新规划Replan。但现实环境是，1）场景很可能复杂，只使用一次规划耗时长，导致计算效率低；2）由于其他交通参与者的存在导致周围环境是随着时间变化的。所以在这样的场景下，为了是规划的路径质量更高，需要不断迭代来适应环境，**规划的路径越长，则越好地避免陷入局部最优解，不影响规划的整体质量。**

- **规划的轨迹长**

1. 是为了保证轨迹（位姿、速度）在较长的时空内尽可能稳定+最优；
2. 对于横向轨迹和纵向速度的跟随控制而言，证明跟踪的这一段是“正确的轨迹”。

- **更新的周期短**

1. 是为了保证将环境变化（位姿、速度）实时地更新到轨迹结果中，尽快用新的测量信息来修正之前的误差。
2. 对于控制而言，的确只用了dt的这一段信息

不考虑误差的话，多周期规划的轨迹在大地坐标下应是一致的。满足这个一致性条件，就可以定周期规划，更短周期去跟踪，最终行驶出一条符合预期的轨迹（位置和速度）。



> 运动规划考虑空间和未来时间这三个维度，就够了吗？要回答这个问题，绕不开体感这个话题。体感也就是物理舒适度（physical  comfort），是驾驶舒适度的一个重要方面，反映了车辆运动的不平滑性。体感与舒适度的其他方面一样，比较主观，评估需要从多种指标考虑。常用的指标包括横向和纵向（lateral and  longitudinal）的加速度（acceleration）和加加速度（jerk）等。从这些指标可以看出，对于体感来说，运动轨迹对时间的导数是非常重要的，理想的运动轨迹在时间上必须足够平滑。

> 上面说到，在运动规划给出的轨迹（对未来运动的规划）里，可以清楚地评估和优化未来运动的平滑性，但过去的运动轨迹则是另一番景象。过去是不可改写的，更重要的是，**过去的轨迹是在过去每一个时间点的未来轨迹的初始段积累而成的，类似于控制中的滚动时域优化（receding horizon  control）**。过去某时刻对当时的未来的规划，也可以因时间推移，感知预测等信息的更新而更改；比如，两秒钟之前规划的轨迹中预计行驶两秒后到达的位置，可以不同于一秒前规划的轨迹中预计行驶一秒后到达的位置，而二者又皆可不同于当前实际所在位置。因此过去这个时间维度不仅仅是未来时间向相反方向的延伸。尤其是这两个时间维度的接合处，也就是当前时刻，是需要额外细致处理的。体感的效果，必须这些地方每一处都精心优化，才能得以保证。

就纵向的速度规划而言，时间维度是平衡横纵向控制的关键因素。针对不同场景规划出的轨迹线需要与之匹配出最优的速度和加速度。例如，对于前方静止障碍物，无人车需要实时地根据不同的当前车速，规划出减速曲线。其中，安全上能保证任何速度下，都能在障碍物前方几米内稳定刹停或者跟停；舒适上开始切入减速的冲击度连续；另外最好不触发AEB紧急制动，这是在感知融合后识别前方静止物后。

那么实际在纵向的速度规划中，时间维度和速度位置维度需要进行反复优化。

# 规划周期与控制周期

在真实的自动驾驶过程中，规划与控制不是同步进行的，并不是说规划出一条局部轨迹后，比如车辆前方8s或200m的轨迹后，控制跟踪完这段轨迹然后再重新规划、重新跟踪，这样无法考虑变化快速的动态环境；也不是说规划出一条局部轨迹后，车辆立马跟踪dt后的一个点，当车辆达到新的规划点后立即重规划；而是规划出一条局部轨迹后，先跟踪一小段时间，再重新规划；规划与控制都有一个周期，每个模块在该周期结束后再次计算更新，规划模块的更新周期称为规划周期，控制模块的更新周期称为控制周期。

一般来说车辆的规划周期为200ms，控制周期为10ms，即规划周期的时间总是大于控制周期的，这样才能让车辆跟踪一段局部轨迹后再重新规划新的局部轨迹，因此过去的轨迹是在过去每一个时间点的未来轨迹的初始段积累而成的，类似于控制中的滚动时域优化（receding horizon  control）